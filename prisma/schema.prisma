// Prisma schema for PostgreSQL database
// This is the single source of truth for the database structure

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH DOMAIN
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String?
  
  role          UserRole  @default(READER)
  isVerified    Boolean   @default(false)
  
  profile       Profile?
  sessions      Session[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([username])
  @@index([role])
  @@map("users")
}

enum UserRole {
  READER
  AUTHOR
  EDITOR
  ADMIN
}

model Profile {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName         String?
  lastName          String?
  displayName       String?
  bio               String?   @db.Text
  avatar            String?
  website           String?
  
  twitter           String?
  linkedin          String?
  github            String?
  
  isAuthorVerified  Boolean   @default(false)
  authorBadge       String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("profiles")
}

model Session {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token         String    @unique
  expiresAt     DateTime
  
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// CONTENT DOMAIN
// ============================================

model Post {
  id              String      @id @default(uuid())
  authorId        String
  
  title           String
  slug            String      @unique
  excerpt         String?     @db.Text
  content         String      @db.Text
  coverImage      String?
  
  status          PostStatus  @default(DRAFT)
  visibility      PostVisibility @default(PUBLIC)
  
  metaTitle       String?
  metaDescription String?     @db.Text
  keywords        String[]
  
  viewCount       Int         @default(0)
  likeCount       Int         @default(0)
  commentCount    Int         @default(0)
  readTime        Int?
  
  publishedAt     DateTime?
  scheduledAt     DateTime?
  
  categories      PostCategory[]
  tags            PostTag[]
  comments        Comment[]
  likes           Like[]
  bookmarks       Bookmark[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
  @@index([slug])
  @@map("posts")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED
}

enum PostVisibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

model Category {
  id            String      @id @default(uuid())
  name          String      @unique
  slug          String      @unique
  description   String?     @db.Text
  icon          String?
  color         String?
  
  parentId      String?
  parent        Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]  @relation("CategoryHierarchy")
  
  posts         PostCategory[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Tag {
  id            String      @id @default(uuid())
  name          String      @unique
  slug          String      @unique
  
  posts         PostTag[]
  
  createdAt     DateTime    @default(now())
  
  @@index([slug])
  @@map("tags")
}

model PostCategory {
  postId        String
  categoryId    String
  
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  category      Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@id([postId, categoryId])
  @@map("post_categories")
}

model PostTag {
  postId        String
  tagId         String
  
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
  @@map("post_tags")
}

model Comment {
  id            String      @id @default(uuid())
  postId        String
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId      String
  content       String      @db.Text
  
  parentId      String?
  parent        Comment?    @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[]   @relation("CommentReplies")
  
  status        CommentStatus @default(APPROVED)
  
  likeCount     Int         @default(0)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([status])
  @@map("comments")
}

enum CommentStatus {
  PENDING
  APPROVED
  SPAM
  DELETED
}

model Like {
  id            String      @id @default(uuid())
  userId        String
  postId        String
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  
  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("likes")
}

model Bookmark {
  id            String      @id @default(uuid())
  userId        String
  postId        String
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  
  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("bookmarks")
}

// ============================================
// MEDIA DOMAIN
// ============================================

model Media {
  id              String      @id @default(uuid())
  userId          String
  
  filename        String
  originalName    String
  mimeType        String
  size            Int
  
  storageProvider String
  storageKey      String
  url             String
  
  variants        MediaVariant[]
  
  width           Int?
  height          Int?
  duration        Int?
  
  status          MediaStatus @default(PROCESSING)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
  @@index([status])
  @@map("media")
}

enum MediaStatus {
  PROCESSING
  READY
  FAILED
}

model MediaVariant {
  id            String      @id @default(uuid())
  mediaId       String
  media         Media       @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  
  variant       String
  url           String
  width         Int?
  height        Int?
  size          Int?
  
  @@index([mediaId])
  @@map("media_variants")
}
